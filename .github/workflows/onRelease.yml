name: Release to Nuget

on:
    workflow_dispatch:
    push:
        tags:
            - 'v*.*.*'

jobs:
    # ------------------------------------------------------------------------------------------------------------------
    # Build multi-architecture binaries
    # ------------------------------------------------------------------------------------------------------------------
    build:
        name: Build ${{ matrix.os }} / ${{ matrix.arch }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      arch: x64
                    - os: ubuntu-24.04-arm
                      arch: arm64
                    - os: windows-latest
                      arch: x64
                    - os: windows-11-arm
                      arch: arm64
                    - os: macos-15-intel
                      arch: x64
                    - os: macos-latest
                      arch: arm64
        env:
            DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
            DOTNET_CLI_TELEMETRY_OPTOUT: 1
            Configuration: Release
        
        steps:
            -   uses: actions/checkout@v5
                with:
                    fetch-depth: 0

            -   name: Setup .NET 9 SDK
                uses: actions/setup-dotnet@v5
                with:
                    dotnet-version: '9.x'

            -   name: Cache NuGet packages
                uses: actions/cache@v4
                with:
                    path: ~/.nuget/packages
                    key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
                    restore-keys: ${{ runner.os }}-nuget-

            -   name: Setup CMake
                uses: lukka/get-cmake@latest
        
            # ---------------- Linux/macOS dependencies ----------------
            -   name: Install GTK3 (Linux)
                if: startsWith(matrix.os, 'ubuntu')
                run: | 
                    sudo apt-get update
                    sudo apt install -y  \
                        libgtk-3-dev \
                        libwebkit2gtk-4.1-dev \
                        libssl-dev \
                        libcurl4-openssl-dev \
                        zlib1g-dev \
                        libnotify-dev

            -   name: Install GTK3 (macOS)
                if: startsWith(matrix.os, 'macos')
                run: brew install gtk+3 pkg-config
            
            # ---------------- Build Windows ----------------
            -   name: Build InfiniFrame.Native (Windows)
                if: startsWith(matrix.os, 'windows')
                shell: pwsh
                run: |
                    dotnet build "src/InfiniLore.InfiniFrame.Native/InfiniLore.InfiniFrame.Native.proj" `
                        --configuration Release `
                        --no-restore `
                        -p:SolutionDir="${{github.workspace}}/" `
                        -p:Platform=${{ matrix.arch }}
            
            # ---------------- Build Linux ----------------
            -   name: Build InfiniFrame.Native (Linux)
                if: startsWith(matrix.os, 'ubuntu')
                run: |
                    dotnet build "src/InfiniLore.InfiniFrame.Native/InfiniLore.InfiniFrame.Native.proj" \
                        --configuration Release \
                        --no-restore \
                        /p:SolutionDir="${{github.workspace}}/" \
                        /p:Platform=${{ matrix.arch }}
            
            # ---------------- Build macOS ----------------
            -   name: Build InfiniFrame.Native (macOS)
                if: startsWith(matrix.os, 'macos')
                run: |
                    dotnet build "src/InfiniLore.InfiniFrame.Native/InfiniLore.InfiniFrame.Native.proj" \
                        --configuration Release \
                        --no-restore \
                        /p:SolutionDir="${{github.workspace}}/" \
                        /p:Platform=${{ matrix.arch }}

            -   name: Debug list everything
                run: |
                    echo "=== Workspace contents ==="
                    ls -R .
                    echo "=== Expected path ==="
                    ls -R ${{github.workspace}}/artifacts/native || true
                    
            -   name: Upload build artifact
                uses: actions/upload-artifact@v5
                with:
                    name: app-${{ matrix.os }}-${{ matrix.arch }}
                    path: ${{github.workspace}}/artifacts/native/${{ matrix.arch }}/Release
    
    release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: build
        steps:
            -   uses: actions/checkout@v5
                with:
                    fetch-depth: 0

            -   name: Setup .NET 9 SDK
                uses: actions/setup-dotnet@v5
                with:
                    dotnet-version: '9.x'
            
            -   name: build dotnet
                run: |
                    # Build native project first
                    dotnet build src/InfiniLore.InfiniFrame.Native/InfiniLore.InfiniFrame.Native.proj \
                      --configuration Release \
                      --no-restore \
                      /p:SolutionDir=${{github.workspace}}/
                    
                    dotnet build InfiniLore.InfiniFrame.GitHubActions.Pack.slnf \
                      --configuration Release \
                      --no-restore \
                      /p:SolutionDir=${{github.workspace}}/
                    
            -   name: Download build artifacts
                uses: actions/download-artifact@v6
                with:
                    path: artifacts/native

            -   name: List native artifacts
                run: |
                    ls -R artifacts/native
                    
            -   name: Verify native artifacts
                run: |
                    echo "Checking native build artifacts..."
                    EXPECTED_ARTIFACTS=(
                      "windows/x64/Release/InfiniLore.InfiniFrame.Native.dll"
                      "windows/x64/Release/WebView2Loader.dll"
                      "windows/arm64/Release/InfiniLore.InfiniFrame.Native.dll"
                      "windows/arm64/Release/WebView2Loader.dll"
                      "linux/x64/Release/InfiniLore.InfiniFrame.Native.so"
                      "linux/arm64/Release/InfiniLore.InfiniFrame.Native.so"
                      "osx/x64/Release/InfiniLore.InfiniFrame.Native.dylib"
                      "osx/arm64/Release/InfiniLore.InfiniFrame.Native.dylib"
                    )
                    
                    MISSING=0
                    for file in "${EXPECTED_ARTIFACTS[@]}"; do
                      if [ ! -f "./artifacts/native/$file" ]; then
                        echo "❌ Missing artifact: $file"
                        MISSING=$((MISSING+1))
                      else
                        echo "✅ Found: $file"
                      fi
                    done
                    
                    if [ $MISSING -gt 0 ]; then
                      echo "❌ $MISSING artifact(s) missing! Aborting."
                      exit 1
                    fi
                    
            -   name: pack
                run: |                    
                    dotnet pack InfiniLore.InfiniFrame.GitHubActions.Pack.slnf --configuration Release -o ./release

            -   name: Create GitHub Release
                uses: softprops/action-gh-release@v2
                with:
                    files: release/*.zip
                    generate_release_notes: true

#    nuget:
#        name: Publish to NuGet
#        runs-on: ubuntu-latest
#        needs: build
#        if: startsWith(github.ref, 'refs/tags/v')
#        steps:
#            -   name: Checkout repository
#                uses: actions/checkout@v5
#
#            -   name: Setup .NET
#                uses: actions/setup-dotnet@v5
#                with:
#                    dotnet-version: '9.0.x'
#
#            -   name: Build (for NuGet)
#                run: dotnet pack --configuration Release -o ./nupkgs
#              
#            -   name: Upload NuGet packages as debug artifact
#                uses: actions/upload-artifact@v5
#                with:
#                    name: nuget-packages-${{ github.ref_name }}
#                    path: ./nupkgs/*.nupkg

#            - name: Push to NuGet
#              run: dotnet nuget push "./nupkgs/*.nupkg" --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
#              env:
#                  NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
